# 美国市场量化交易工作流

## 概述

`us_market_workflow.py` 是一个基于Qlib框架的美国股市量化交易策略回测脚本，仿照 `examples/workflow_by_code.py` 创建，但专门针对美国市场进行了配置调整。

## 主要特性

- **市场**: NASDAQ100
- **基准指数**: S&P500 (^GSPC)
- **模型**: LightGBM (GBDT)
- **特征**: Alpha158因子
- **策略**: TopkDropout策略
- **数据区域**: 美国 (REG_US)

## 与中国市场版本的主要差异

| 配置项 | 中国市场版本 | 美国市场版本 |
|--------|-------------|-------------|
| 数据区域 | REG_CN | REG_US |
| 市场 | CSI300 | NASDAQ100 |
| 基准指数 | SH000300 | ^GSPC |
| 数据目录 | ~/.qlib/qlib_data/cn_data | ~/.qlib/qlib_data/us_data |
| 涨跌停限制 | 0.095 (9.5%) | None (无限制) |
| 交易成本 | 开仓0.0005, 平仓0.0015 | 开仓0.001, 平仓0.001 |
| 最小交易成本 | 5元 | 1美元 |

## 使用方法

### 1. 环境准备

确保已安装Qlib框架：
```bash
pip install qlib
```

### 2. 数据准备

脚本会自动下载美国市场数据到 `~/.qlib/qlib_data/us_data` 目录。

### 3. 运行脚本

```bash
cd src/demo
python us_market_workflow.py
```

## 工作流程

1. **数据准备**: 自动下载美国股市数据
2. **模型训练**: 使用LightGBM模型在训练集上训练
3. **信号生成**: 生成交易信号
4. **信号分析**: 分析信号质量
5. **回测**: 使用TopkDropout策略进行回测
6. **结果记录**: 保存实验结果和模型参数

## 时间段配置

- **训练期**: 2008-01-01 至 2014-12-31
- **验证期**: 2015-01-01 至 2016-12-31  
- **测试期**: 2017-01-01 至 2020-08-01
- **回测期**: 2017-01-01 至 2020-08-01

## 策略参数

- **选股数量**: 50只股票
- **Dropout数量**: 5只股票
- **初始资金**: 1亿美元
- **交易频率**: 日频

## 运行结果示例

### 模型训练结果
```
Training until validation scores don't improve for 50 rounds
[20]    train's l2: 0.984323    valid's l2: 0.988874
[40]    train's l2: 0.982348    valid's l2: 0.988733
[60]    train's l2: 0.98072     valid's l2: 0.988782
[80]    train's l2: 0.979086    valid's l2: 0.988927
Early stopping, best iteration is:
[46]    train's l2: 0.981889    valid's l2: 0.988695
```

### 信号分析结果
```
IC (Information Coefficient): 0.0056
ICIR (Information Coefficient IR): 0.0417
Rank IC: 0.0054
Rank ICIR: 0.0404
```

### 回测性能指标

#### 基准收益（S&P500）
```
年化收益率: 12.08%
信息比率: 0.596
最大回撤: -38.25%
```

#### 策略超额收益（无交易成本）
```
年化收益率: 9.12%
信息比率: 1.360
最大回撤: -5.35%
```

#### 策略超额收益（含交易成本）
```
年化收益率: 4.31%
信息比率: 0.644
最大回撤: -10.80%
```

### 性能评估

✅ **策略表现良好**：
- 信息比率1.36（无成本）表明策略具有较好的风险调整收益
- 即使考虑交易成本，年化超额收益仍达到4.31%
- 最大回撤控制在合理范围内（-10.80%）
- 相比基准的-38.25%最大回撤，策略风险控制效果显著

## 输出结果

脚本运行后会生成：
- 模型参数文件 (`params.pkl`)
- 信号记录 (`pred.pkl`)
- 信号分析报告
- 投资组合分析报告 (`port_analysis_1day.pkl`)
- 回测性能指标 (`indicator_analysis_1day.pkl`)

## 注意事项

1. 首次运行需要下载美国市场数据，可能需要较长时间
2. 确保网络连接稳定，以便数据下载
3. 建议在有足够内存的环境中运行
4. 可根据需要调整时间段和策略参数
5. 运行过程中可能出现一些数据警告（如NaN值），这是正常现象

## 扩展使用

可以通过修改以下配置来适应不同需求：
- 更换市场 (如SP500)
- 调整特征集 (如Alpha360)
- 修改模型参数
- 调整策略参数
- 更改时间段

## 验证状态

✅ **已验证**: 代码已成功运行并产生预期结果，所有功能正常工作。 